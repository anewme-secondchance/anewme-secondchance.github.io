<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voice Assistant | A New Me</title>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #eef2f7;
    text-align: center;
}
.header {
    background: #1f3c88;
    color: white;
    padding: 20px;
}
.container {
    padding: 30px;
}
button {
    background: #1f3c88;
    color: white;
    border: none;
    padding: 14px 22px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    margin-top: 15px;
}
select {
    padding: 8px;
    margin-top: 10px;
    border-radius: 6px;
}
.status {
    margin-top: 20px;
    font-weight: bold;
}
.transcript {
    margin-top: 15px;
    color: #333;
    white-space: pre-line;
}
.notice {
    background: #fff3cd;
    color: #856404;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px;
}
</style>
</head>

<body>

<div class="header">
    <h2>ðŸ—£ Reentry Assistant</h2>
</div>

<div class="container">

    <div id="deviceNotice" class="notice"></div>

    <p>Talk to me. What do you need right now?</p>

    <label>Select Voice:</label><br>
    <select id="voiceSelect">
        <option value="female">Female Voice</option>
        <option value="male">Male Voice</option>
    </select>

    <br>
    <button onclick="startListening()">ðŸŽ¤ Tap to Speak</button>

    <div class="status" id="status"></div>
    <div class="transcript" id="transcript"></div>
</div>

<script>

const statusDiv = document.getElementById("status");
const transcriptDiv = document.getElementById("transcript");
const voiceSelect = document.getElementById("voiceSelect");
const deviceNotice = document.getElementById("deviceNotice");

const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);

if (isIOS) {
    deviceNotice.innerText =
        "ðŸ“± iPhone Mode: Responses will appear as text. Tap to speak each time.";
} else {
    deviceNotice.innerText =
        "ðŸ¤– Android/Desktop Mode: The assistant will respond out loud.";
}

/* ---------------- SPEAK ---------------- */
function speak(text) {

    if (isIOS) {
        transcriptDiv.innerText = "AI: " + text;
        return;
    }

    window.speechSynthesis.cancel();
    const speech = new SpeechSynthesisUtterance(text);
    const voices = window.speechSynthesis.getVoices();

    if (voiceSelect.value === "male") {
        const maleVoice = voices.find(v => v.name.toLowerCase().includes("david"));
        if (maleVoice) speech.voice = maleVoice;
    } else {
        const femaleVoice = voices.find(v =>
            v.name.toLowerCase().includes("zira") ||
            v.name.toLowerCase().includes("samantha")
        );
        if (femaleVoice) speech.voice = femaleVoice;
    }

    speech.rate = 0.95;
    window.speechSynthesis.speak(speech);
}

/* ---------------- LISTEN ---------------- */
function startListening() {

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
        alert("Speech recognition not supported. Use Safari on iPhone or Chrome on Android.");
        return;
    }

    const recognition = new SpeechRecognition();
    recognition.lang = "en-US";
    recognition.interimResults = false;
    recognition.continuous = false;

    statusDiv.innerText = "Listening...";
    recognition.start();

    recognition.onresult = function(event) {
        const message = event.results[0][0].transcript;
        transcriptDiv.innerText = "You: " + message;
        statusDiv.innerText = "";

        sendToAI(message);
    };

    recognition.onerror = function() {
        statusDiv.innerText = "Speech failed. Try again.";
    };
}

/* ---------------- SEND TO AI ---------------- */
async function sendToAI(message) {

    statusDiv.innerText = "Thinking...";

    try {
        const response = await fetch("/api/chat", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ message })
        });

        const data = await response.json();

        statusDiv.innerText = "";
        transcriptDiv.innerText += "\n\nAI: " + data.reply;

        speak(data.reply);

    } catch (error) {
        statusDiv.innerText = "";
        transcriptDiv.innerText = "Error connecting to assistant.";
    }
}

</script>

</body>
</html>
