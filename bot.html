<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voice Assistant | A New Me</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #eef2f7;
  text-align: center;
}

.header {
  background: #1f3c88;
  color: white;
  padding: 20px;
}

.container {
  padding: 30px;
}

button {
  background: #1f3c88;
  color: white;
  border: none;
  padding: 14px 22px;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
  margin-top: 15px;
}

select {
  padding: 8px;
  margin-top: 10px;
  border-radius: 6px;
}

.status {
  margin-top: 20px;
  font-weight: bold;
}

.transcript {
  margin-top: 15px;
  color: #333;
}
</style>
</head>

<body>

<div class="header">
<h2>ðŸ—£ Reentry Assistant</h2>
</div>

<div class="container">

<p>Talk to me. What do you need right now?</p>

<label>Select Voice:</label><br>
<select id="voiceSelect">
  <option value="female">Female Voice</option>
  <option value="male">Male Voice</option>
</select>

<br>

<button onclick="startListening()">ðŸŽ¤ Tap to Speak</button>

<div class="status" id="status"></div>
<div class="transcript" id="transcript"></div>

</div>

<script>

const statusDiv = document.getElementById("status");
const transcriptDiv = document.getElementById("transcript");
const voiceSelect = document.getElementById("voiceSelect");

let recorder;
let audioChunks = [];

/* ---------------- SPEAK FUNCTION ---------------- */

function speak(text, redirectPage) {

  window.speechSynthesis.cancel();

  const speech = new SpeechSynthesisUtterance(text);
  const voices = window.speechSynthesis.getVoices();

  if (voiceSelect.value === "male") {
    const maleVoice = voices.find(v => v.name.toLowerCase().includes("david"));
    if (maleVoice) speech.voice = maleVoice;
  } else {
    const femaleVoice = voices.find(v =>
      v.name.toLowerCase().includes("zira") ||
      v.name.toLowerCase().includes("samantha")
    );
    if (femaleVoice) speech.voice = femaleVoice;
  }

  speech.rate = 0.95;

  speech.onend = function() {
    if (redirectPage) {
      setTimeout(() => {
        window.location.href = redirectPage;
      }, 900);
    }
  };

  window.speechSynthesis.speak(speech);
}

/* ---------------- RECORD AUDIO ---------------- */

async function startListening() {

  try {
    statusDiv.innerText = "Recording...";

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    recorder = new MediaRecorder(stream);
    audioChunks = [];

    recorder.ondataavailable = e => {
      audioChunks.push(e.data);
    };

    recorder.onstop = sendAudioToBackend;

    recorder.start();

    setTimeout(() => {
      recorder.stop();
      statusDiv.innerText = "Processing...";
    }, 4000);

  } catch (err) {
    statusDiv.innerText = "Microphone access denied.";
  }
}

/* ---------------- SEND TO BACKEND ---------------- */

async function sendAudioToBackend() {

  const blob = new Blob(audioChunks, { type: "audio/webm" });
  const formData = new FormData();
  formData.append("file", blob, "speech.webm");

  try {

    const response = await fetch("https://voice-backend-r1yo.onrender.com/speech", {
      method: "POST",
      body: formData
    });

    const data = await response.json();

    transcriptDiv.innerText = "You said: " + data.text;

    routeUser(data.text.toLowerCase());

    statusDiv.innerText = "";

  } catch (error) {
    statusDiv.innerText = "Speech processing failed.";
  }
}

/* ---------------- ROUTING ---------------- */

function routeUser(message) {

  if (
    message.includes("scared") ||
    message.includes("overwhelmed") ||
    message.includes("lost") ||
    message.includes("stressed")
  ) {
    speak("Hey. Look at me. Breathe. You survived worse than this. We are handling this one step at a time. Whatâ€™s first?");
    return;
  }

  if (message.includes("job") || message.includes("work")) {
    saveTopic("employment");
    speak("Good. Weâ€™re not sitting still. Letâ€™s get you working.", "employment.html");
  }

  else if (message.includes("id")) {
    saveTopic("id");
    speak("We need that ID handled. No excuses. Iâ€™m taking you there now.", "id-help.html");
  }

  else if (message.includes("house") || message.includes("rent")) {
    saveTopic("housing");
    speak("Housing is priority. Stability first. Opening it now.", "housing.html");
  }

  else if (message.includes("money") || message.includes("budget")) {
    saveTopic("money");
    speak("Weâ€™re getting your money right. Letâ€™s move.", "money.html");
  }

  else {
    speak("Say job, housing, ID, or money. Weâ€™re moving forward.");
  }
}

/* ---------------- SAVE DATA ---------------- */

function saveTopic(topic) {

  localStorage.setItem("lastTopic", topic);

  let visits = parseInt(localStorage.getItem("visits")) || 0;
  visits += 1;
  localStorage.setItem("visits", visits);
}

/* ---------------- ON LOAD ---------------- */

window.onload = function() {

  const visits = parseInt(localStorage.getItem("visits")) || 0;
  const lastTopic = localStorage.getItem("lastTopic");

  setTimeout(() => {

    if (visits === 0) {
      speak("Alright. Fresh start. Iâ€™m with you.");
    } 
    else if (visits <= 3) {
      speak("I see you showing up. Thatâ€™s how change happens.");
    } 
    else if (visits <= 6) {
      speak("Youâ€™re building momentum. Donâ€™t stop now.");
    } 
    else {
      speak("Youâ€™re not the same person you were. I see the work.");
    }

    if (lastTopic) {
      setTimeout(() => {
        speak("Last time we were working on " + lastTopic + ". We finishing that?");
      }, 2500);
    }

  }, 800);
};

</script>

</body>
</html>
